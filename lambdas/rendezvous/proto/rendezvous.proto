syntax = "proto3";

package rendezvous;

service ClientService {
  // Publish-Subscribe
  rpc RecoverBranches(RecoverBranchesMessage) returns (RecoverBranchesResponse);
  rpc SubscribeBranches(SubscribeBranchesMessage) returns (stream SubscribeBranchesResponse);
  
  // Unidirectional Streaming
  rpc CloseBranches(stream CloseBranchMessage) returns (Empty);

  rpc RegisterRequest(RegisterRequestMessage) returns (RegisterRequestResponse);
  rpc RegisterBranch(RegisterBranchMessage) returns (RegisterBranchResponse);
  rpc RegisterBranches(RegisterBranchesMessage) returns (RegisterBranchesResponse);
  rpc CloseBranch(CloseBranchMessage) returns (Empty);
  rpc WaitRequest(WaitRequestMessage) returns (WaitRequestResponse);
  rpc CheckRequest(CheckRequestMessage) returns (CheckRequestResponse);
  rpc CheckRequestByRegions(CheckRequestByRegionsMessage) returns (CheckRequestByRegionsResponse);
  rpc GetPreventedInconsistencies(Empty) returns (GetPreventedInconsistenciesResponse);
}

// -----------------
// Publish-Subscribe
// -----------------

message RecoverBranchesMessage {
  string service = 1;
}

message RecoverBranchesResponse {
  repeated string bids = 1;
  bool done = 2;
}

message SubscribeBranchesMessage {
  string service = 1;
  string tag = 2;
}

message SubscribeBranchesResponse {
  string bid = 1;
}

// -----------------------
// Bidirectional Streaming
// -----------------------

/* Pending Requests */

message WatchOpenedRequestsMessage {
  string service = 1;
}

message WatchOpenedRequestsResponse {
  repeated string rids = 1;
  bool done = 2;
}

/* Waiting Requests */

message WatchPendingRequestsMessage {
  string service = 1;
}

message WatchPendingRequestsResponse {
  repeated string rids = 1;
  bool done = 2;
}

// ------------------------
// Unidirectional Streaming
// ------------------------

/* Pending Requests */

message GetOpenedRequestsMessage {
  string service = 1;
}

message GetOpenedRequestsResponse {
  repeated string rids = 1;
}

// -----------
// Unary RPCs
// -----------

/* Helpers */

enum RequestStatus {
  OPENED = 0;
  CLOSED = 1;
  NOT_FOUND = 2;
}

message Empty {

}

message RequestContext {
  map<string, int32> versions = 1;
}

/* Register Request */

message RegisterRequestMessage {
  string rid = 1;
}

message RegisterRequestResponse {
  string rid = 1;
  RequestContext context = 2;
}

/* Register Branch */

message RegisterBranchMessage {
  string rid = 1;
  string service = 2;
  string tag = 3;
  string region = 4;
  RequestContext context = 5;
}

message RegisterBranchResponse {
  string rid = 1;
  string bid = 2;
  RequestContext context = 3;
}

/* Registers Branches */

message RegisterBranchesMessage {
  string rid = 1;
  string service = 2;
  string tag = 3;
  repeated string regions = 4;
  RequestContext context = 5;
}

message RegisterBranchesResponse {
  string rid = 1;
  string bid = 2;
  RequestContext context = 3;
}

/* Close Branch */

message CloseBranchMessage {
  string bid = 1;
  string region = 2;
  RequestContext context = 3;
}

/* Wait Request */

message WaitRequestMessage {
  string rid = 1;
  string service = 2;
  string region = 3;
  int32 timeout = 4;
  RequestContext context = 5;
}

message WaitRequestResponse {
  bool prevented_inconsistency = 1;
}

/* Check Request */

message CheckRequestMessage {
  string rid = 1;
  string service = 2;
  string region = 3;
  RequestContext context = 4;
}

message CheckRequestResponse {
  RequestStatus status = 1;
}

/* Check Request by Regions */

message CheckRequestByRegionsMessage {
  string rid = 1;
  string service = 2;
  RequestContext context = 4;
}

message CheckRequestByRegionsResponse {
  map<string, RequestStatus> statuses = 1;
}

/* Get Prevented Inconsistencies */

message GetPreventedInconsistenciesResponse {
  int64 inconsistencies = 1;
}